---
title: "Data Wrangling for Visualization, Part 2"
author: "Jeremy Mikecz"
format: html
editor: visual
---

# Data Wrangling for Visualization, Weather Data Part 2

In the previous notebook, you learned how to subset and re-shape a large dataset to create a simple line graph showing changes in yearly max and min temperatures for Hanover, NH. If nothing else, the results clearly show steadily warming local temperatures.

However, the advanced capabilities of computational graphics mean that we can represent data trends in far higher resolution.

In this notebook, we will visualize temperature fluctuations at the daily rather than yearly level.

# 1. Setup

## 1.1 Import necessary packages

```{r}
library(tidyverse)
options(repr.plot.width = 20, repr.plot.height = 12)
```

## 1.2 Import Data

```{r}
df <- read.csv("../data/Hanover_weather-data_1884-2025.csv")


```

# 2. Planning

Examine the columns and data contained in this dataset using the functions below. Think about which data fields (columns) we want to keep and how we may want to modify them to accomplish the following task:

-   visualize daily temperature changes for each year in the 21st century in comparison to the average temperature for each given day during the 20th century.

    ```{r}
    tail(df)

    ```

    ```{r}
    colnames(df)
    ```

    ```{r}
    print(summary(df))
    ```

    Brainstorm the steps we will need to take to achieve the goals stated above.

    ```         
    # Write the steps you think are needed below:






















    ```

# 3. Steps

```         
1. standardize dates
2. drop unneeded columns
3. calculate average daily temperatures for 20th century
    a. assign each day a day number
    b. group by day number and calculate average max and min temperatures
4. calculate difference between each day's max and min temperatures and the 20th century average for that day
5. wide to long?
    
```

# 4. Standardize Dates

```{r}
library(lubridate)
df <- df |>
    mutate(DATE2 = parse_date_time(DATE, orders = c("ymd", "mdy"))) |>
    mutate(DATE2 = as.Date(DATE2))
```

# 5. Keep only needed columns and complete years

```{r}
cols_to_keep = c("NAME", "DATE2", "TMAX", "TMIN")
print(dim(df))
df2 <- df |>
    select(all_of(cols_to_keep)) |>
    mutate(YEAR = year(ymd(DATE2)),
           MON = month(ymd(DATE2)),
           DAY = day(ymd(DATE2)),
           month = month(ymd(DATE2), label=TRUE, abbr=TRUE)
           ) |>
    filter(YEAR >= 1894 & YEAR <= 2024)
colnames(df2)
print(dim(df2))
```

# 6. Calculate average daily temperature for 20th century

## 6a. Assign day numbers (1 –\> 365 or 366) for the day of the year

First, let's make sure the data is arranged in chronological order.

```{r}
df2 <- df2 |>
    arrange(DATE2)

print(head(df2$DATE2))
print(tail(df2$DATE2))
```

```{r}
df2 <- df2 |>
    mutate(daynum = yday(DATE2))

head(df2)
```

## 6b. Group by day number and calculate average temperatures

```{r}
df20c <- df2 |>
  filter(YEAR >= 1900 & YEAR <= 1999)
```

```{r}
df20c_avgs <- df20c |>
    group_by(MON, DAY) |>
    summarize(Avg_TMAX_20c = mean(TMAX, na.rm = TRUE),
              Avg_TMIN_20c = mean(TMIN, na.rm = TRUE),
              .groups = 'drop')
    

```

```{r}
df2 <- df2 |>
    left_join(df20c_avgs, by=c("MON", "DAY"))
```

```{r}
df2 <- df2 |>
    mutate(tmax_diff_20c_avg = TMAX - Avg_TMAX_20c,
           tmin_diff_20c_avg = TMIN - Avg_TMIN_20c
           )
```

```{r}
write.csv(df2, "../data/Hanover_temps_1894-2024.csv")
```

```{r}
df_2024 <- df2 |>
    filter(YEAR == 2024)
```

```{r}
month.abb
```

```{r}
months <- rep(1:12, times = c(31, 29, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31))  # Days per month, leap year
```

```{r}
months
```

## 6c. Set up Labels

We want to place monthly labels at the midway point of each month.

```{r}
month_positions <- df_2024 |>
  group_by(month) |>
  summarize(mid_day = mean(daynum)) |>
  ungroup()
month_positions
```

```{r}
# Prepare day breaks for every 10 days (skip > 366 for leap year safely)
day_breaks <- seq(1, 366, by = 10)
day_break_labels <- as.character(day_breaks)
day_break_labels
```

```{r}

```

## 7. Visualizing

```{r}

```

```{r}
ggplot(df_2024, aes(
    #x = factor(DATE2),
    x = daynum,
    y = tmax_diff_20c_avg,
    fill = tmax_diff_20c_avg)
    ) +
    geom_bar(stat = "identity") +
    scale_fill_gradient2(low = "blue", mid = "white", high = "red", 
                       midpoint = 0, name = "Temperature Difference") +
    theme_minimal() +
    coord_polar(start = -pi/2) +        # rotate to put Jan 1 on top
    # main axis: day number every 10 days on x
    scale_x_continuous(
        breaks = day_breaks,
        labels = day_break_labels,
        limits = c(1, 366),
        expand = c(0, 0)
    ) +
    # Add month labels manually with annotate()
    annotate(
        "text",
        x = month_positions$mid_day,
        y = max(df_2024$tmax_diff_20c_avg, na.rm = TRUE) * 1.1,  # just outside bars
        label = month_positions$month,
        size = 4,
        fontface = "bold",
        angle = (month_positions$mid_day / 366) * 360 - 90,    # align angle to position on circle
        hjust = 0.5,
        vjust = 0.5
      ) +

    labs(title = "Daily Max Temperature Difference from 20th Century Average",
       x = "Day of Year",
       y = "Temperature Difference (°C)") +
    theme(
        axis.title.x = element_text(margin = margin(t = 15)),
        axis.text.x = element_text(size = 8)
  )
    #theme(axis.text.x = element_text(angle = 90, hjust = 1), 
    #    plot.background = element_rect(fill = "white")) 

ggsave("test.png", height=12, width=20)
```

```{r fig.width=14, fig.height = 60}

#options(repr.plot.width=30, repr.plot.height=50)
ggplot(df2 |> filter(YEAR>2015), aes(x=daynum, y=Avg_TMAX_20c, fill=Avg_TMAX_20c)) +
    geom_bar(stat="identity") +
    facet_wrap(~YEAR, ncol=1) #+
    #scale_fill_viridis(option = "plasma")
```

# EXERCISE:

Create a similar graph, but this time showing the average yearly rain and snowfall for Hanover.

## Exploring the Dataset

## Wide to Long

## Long to Wide

## Factors & Data Type Conversion
