---
title: "01_creating-your-own-theme"
author: "Jeremy Mikecz"
editor: visual
format: html
---

# Applying your own style guide to your visualizations

## 1. Setup + Reload Gapminder data

Before beginning with customization, let's first reload our gapminder visualization.

```{r}

library(tidyverse)
library(viridis)
library(systemfonts)
library(showtext)
```

```{r}
# note: to open the gapminder dataset, we have to use a different relative path
# than last week since this notebook is in a different location

df <- read.csv("../../week3/data/gapminder.csv")
head(df)
```

## 2. Create static scatterplot of Gapminder data

This is the same code we developed in the previous notebook.

```{r}
yr = 1997
tempdf <- df |>
    filter(year == yr)

p <- ggplot(tempdf, aes(x= gdpPercap, y=lifeExp, color=continent, size=pop)) +
    geom_point(alpha=0.6) +
    scale_x_continuous(trans="log10") +
    scale_size_continuous(range = c(1, 15)) +
    labs(x="GDP per capita", y = "Life expectancy at birth (years)", 
         title = sprintf("Scatterplot: per capita GDP vs. life expectancy, %s", yr),
       caption = "(Based on data from Hans Rosling - gapminder.com)", 
       color = 'Continent',
       size = "Population")
    #scale_color_viridis(discrete=TRUE, option="turbo")

p

```

## 3. Using Themes

For each plot you make, you can customize in a variety of ways. You can customize the text (justification, font family, style, size, color), the plot itself (background color, axes, axes labels, tick labels), the legend, and more.

However, if you regularly create visualizations this can be tedious to modify every time. This is especially the case if you are preparing plots for publication: you'll want to create and apply a consistent style. We can do that in R in several ways (in order of complexity):

1.  use a preset ggplot theme (Step 4 below)
2.  import and use a preset theme from another R library (Step 5)
3.  create your own theme from scratch (Step 6).

## 4. GGplot Themes

GGplot provides a [list of ggplot themes](https://ggplot2.tidyverse.org/reference/ggtheme.html):\

```         
theme_grey() / theme_gray()
theme_bw()
theme_linedraw()
theme_light()
theme_dark()
theme_minimal()
theme_classic()
theme_void()
theme_test()
```

We can apply these themes to an existing plot quite simply:

```{r}
p +
    theme_minimal()
```

```{r}
p + 
 theme_bw()
```

Unfortunately, the these preset themes are limited and not very creative.

## 5. Import additional themes with ggthemes

Besides the default ggplot themes, you can supplement with additional themes using the [ggthemes](https://r-graph-gallery.com/package/ggthemes.html) package.

For more information see the **ggthemes** [github page](https://jrnold.github.io/ggthemes/) and this R Graph Gallery [tutorial](https://r-graph-gallery.com/package/ggthemes.html).

1.  To use **ggthemes** first install it.

```{r}
# install.packages("ggthemes")  #comment out after installed
```

2.  Import it.

```{r}
library(ggthemes)
```

3.  To get a list of available themes from ggthemes, review the links above or run this:

```{r}
themes <- lsf.str("package:ggthemes", pattern = "theme_")
themes
```

4.  Let's examine what these themes look like.

```{r}
p + 
    theme_foundation()
```

```{r}
p + 
    theme_economist()
```

```{r}
p + 
    theme_economist() +     
    scale_color_economist()
```

```{r}
p + 
    theme_economist_white()+
    scale_color_economist()
```

```{r}
p + 
    theme_fivethirtyeight()
```

```{r}
p + 
    theme_fivethirtyeight() +
    scale_color_fivethirtyeight()
```

### EXERCISE - ggthemes:

Experiment modifying our plot with another ggtheme. Find your favorite.

```{r}

```

## 6. Modifying an existing theme (font size & placement, etc.)

```{r}
windowsFonts()
```

```{r}
#install.packages("showtext")
library(showtext)
```

```{r}
google_font_list <- sysfonts::font_families_google()
writeLines(google_font_list, "google_fonts_list.txt")
```

```{r}
font_add_google(name = "Playfair Display SC", #fonts on the Google Fonts site 
                family = "Playfair Display SC" # Load the fonts for all graphic devices
)
font_add_google(name = "Montserrat",
                family = "Montserrat"
)
showtext_auto()
```

We can modify these existing themes using the **themes()** function. Below we apply custom font and font sizes to `theme_fivethirtyeight()` from **ggthemes**.

```{r}
yr = 1997
tempdf <- df |>
    filter(year == yr)

p <- ggplot(tempdf, aes(x= gdpPercap, y=lifeExp, color=continent, size=pop)) +
    geom_point(alpha=0.6) +
    scale_x_continuous(trans="log10") +
    scale_size_continuous(range = c(1, 15)) +
    labs(x="GDP per capita", y = "Life expectancy at birth (years)", 
         title = sprintf("Scatterplot: per capita GDP vs. life expectancy, %s", yr),
       caption = "(Based on data from Hans Rosling - gapminder.com)", 
       color = 'Continent',
       size = "Population") +
    #scale_color_viridis(discrete=TRUE, option="turbo")
    theme_fivethirtyeight() +
    theme(
        plot.title = element_text(family = "Playfair Display SC", size = 20),
        text = element_text(family = "Montserrat")
    )
p
```

**NOTE**: Within this notebook, some of these plots may not be scaled correctly. The goal of these in-notebook plots is just to get a quick preview. However, it is when we output these plots that we want to make sure they are exported in a way that works visually.

Save plot.

```{r}
ggsave(
    "gapminder-scatter_custom.png",
)
```

You'll probably notice in this outputed png that the text appears too small. We can fix this in two ways. One is to reduce the resolution of the plot:

```{r}
ggsave(
    "gapminder-scatter_custom-small.png",
    width = 6,
    height = 4.5
)
```

Or we can increase the base size of our chosen theme's fonts (so we don't have to re-size all text elements individually).

```{r}
p <- p +
    theme_fivethirtyeight(base_size = 36) +
    theme(
        plot.title = element_text(family = "Playfair Display SC"),
        text = element_text(family = "Montserrat")
    )

ggsave(
    "gapminder-scatter_custom-largerfont.png",
    width = 10,
    height = 7
)
```

I still don't like the scaling of this image's legend (open "gapminder-scatter_custom-largerfont.png" which is saved in the current working directory). Before trying to further customize the `fivethirtyeight()` theme we used above, let's view the underlying code:

```{r}
theme_fivethirtyeight
```

Note: this custom theme was built on

```{r}
p +
  theme(
    legend.box.spacing = unit(0.2, "cm"),  # Reduce space between plot and legend
    legend.margin = margin(t = 0, r = 0, b = 0, l = 0)  # Remove legend margins
  )

ggsave(
    "gapminder-scatter_custom-largerfont2.png",
    width = 10,
    height = 7
)
```

Not perfect, but looking much better.

### Exercise: Export your own version of the Gapminder scatterplot using a theme from ggplot or ggtheme and then modifying it for both clarity and aesthetic style.

```{r}

```

## 7. Creating your own theme from an existing style guide: Reconstructing *The Urban Institute* theme.

Often we may prefer to create our own theme based on our own style guide.

This is especially the case if you want to develop your own style for a series of plots to appear in a publication or to develop your own visual identity.

Here are some core elements we may want to define when creating our own theme:

### **1. Text Elements**

-   `text` - All text elements (base) - font family, style, size

-   `plot.title` - Main plot title

-   `plot.subtitle` - Subtitle

-   `axis.title` - Axis titles (or `axis.title.x` and `axis.title.y` separately)

-   `axis.text` - Axis tick labels (or `axis.text.x` and `axis.text.y`)

-   `legend.title` - Legend title

-   `legend.text` - Legend labels

### **2. Line Elements**

-   `axis.line` - Axis lines

-   `axis.ticks` - Axis tick marks

-   `panel.grid.major` - Major grid lines

-   `panel.grid.minor` - Minor grid lines

### **3. Rectangle Elements**

-   `plot.background` - Background of entire plot

-   `panel.background` - Background of plot panel

-   `legend.background` - Legend background

-   `strip.background` - Facet label background

### **4. Layout Elements**

-   `plot.margin` - Margins around the plot

-   `legend.position` - Legend placement ("top", "bottom", "left", "right", "none")

-   `panel.spacing` - Space between facet panels

We have two main ways to create our own theme:

1.  Create a new theme from scratch (requires more code, but allows you to start completely from scratch).
2.  Begin with an existing theme and modify all elements you want to change (requires less code). Note: when we viewed the `theme_fivethirtyeight()` code above, you can see it was built on `theme_minimal()`.

For option #1, review the code in "theme_custom_scratch.R" in this working directory. It's quite long and complicated, with 200+ lines of code. Fortunately, LLMs make writing this type of code easy (all from-scratch themes found in this working directory were made with the assistance of LLMs). **In the next notebook, you will use LLMs to help you create your own custom theme from scratch.** For the moment, it's useful to just see what this code looks like.

For option #2, besides reviewing the `theme_fivethirtyeight()` code above, you can also look at `theme_custom.R` which creates the same basic custom theme as the script above, but built on `theme_minimal()`. We can import and apply both themes to check it out below:

```{r}
source("theme_custom_scratch.R")
p +
    theme_custom_scratch()
```

```{r}
source("theme_custom.R")
p +
    theme_custom()
```

This custom theme is pretty lame. We can do better.

Before trying to create our own personalized theme, however, let's try to create a theme using an existing style guide, that of The *Urban Institute* \[UI\].

-   this is a useful theme to start with as the Urban Institute \[UI\] has carefully outlined their design choices in their [style guide](https://urbaninstitute.github.io/graphics-styleguide/).

-   *Note: the UI has already done this using [urbnthemes](https://urbaninstitute.github.io/urbnthemes/) package, but we will recreate this theme from scratch.*

-   [List](https://docs.google.com/spreadsheets/d/1F1gm5QLXh3USC8ZFx_M9TXYxmD-X5JLDD0oJATRTuIE/edit?usp=sharing) of other style guides available online

First, the UI uses Google's [Lato](https://fonts.google.com/specimen/Lato) font. Let's import it:

```{r}
font_add_google("Lato", "Lato")
font_add_google("Lato", "Lato Light", regular.wt = 300)
font_add_google("Lato", "Lato Bold", regular.wt = 700)

# Automatically use showtext for graphics
showtext_auto()
```

Next, we should set the UI color palette. Note: the Urban Institute defines not only individual colors but also shades and specific palettes. Review the UI's [style guide](https://urbaninstitute.github.io/graphics-styleguide/). For example, they describe their colors this way:

```         
Urban's main colors are cyan, gray, and black. Yellow and magenta are used as secondary colors throughout the new Urban brand. In general, yellow and magenta should be used sparingly; these colors are best for highlighting purposes, such as when drawing attention to a certain category or indicating a trend line. Tertiary colors for graphics include space gray, green, and red, and should be used infrequently. 
```

We can place their colors into a list (note: the order of the colors in the categorical sub-palette follow the suggested order in the UI style guide.

```{r}
# Urban Institute Color Palette
urban_colors <- list(
  # Primary colors
  cyan = "#1696d2",
  gray = "#d2d2d2",
  black = "#000000",
  
  # Secondary colors
  yellow = "#fdbf11",
  magenta = "#ec008b",
  green = "#55b748",
  space_gray = "#5c5859",
  red = "#db2b27",
  
  # Shades of cyan
  cyan_shade = c("#CFE8F3", "#A2D4EC", "#73BFE2", "#46ABDB", "#1696D2", "#12719E", "#0a4c6a", "#062635"),
  
  # Shades of gray
  white_shade = c("#F5F5F5","#ECECEC","#E3E3E3","#DCDBDB","#D2D2D2","#9D9D9D","#696969","#353535"),
  
  yellow_shade = c("#FFF2CF","#FCE39E","#FDD870","#FCCB41","#FDBF11","#E88E2D","#CA5800","#843215"),
  
  magenta_shade = c("#F5CBDF","#EB99C2","#E46AA7","#E54096","#EC008B","#AF1F6B","#761548","#351123"),
  
  green_shade = c("#DCEDD9","#BCDEB4","#98CF90","#78C26D","#55B748","#408941","#2C5C2D","#1A2E19"),
  
  gray_shade = c("#D5D5D4","#ADABAC","#848081","#5C5859","#332D2F","#262223","#1A1717","#0E0C0D"),
  
  red_shade = c("#F8D5D4","#F1AAA9","#E9807D","#E25552","#DB2B27","#A4201D","#6E1614","#370B0A"),
  
  # Categorical palette
  categorical = c("#1696d2", "#000000", "#d2d2d2", "#fdbf11", "#ec008b", "#55b748", "#0a4c6a", "#CA5800", "#5c5859", "#db2b27") #
)
```

We can now create a function to call these colors. In the function below, a sub-palette is called (default: 'categorical') and a number of colors is set. There is also an option to reverse the palette.

```{r}
# Function to access Urban Institute colors
urban_palette <- function(palette = "categorical", n = NULL, reverse = FALSE) {
  pal <- urban_colors[[palette]]
  
  if (reverse) pal <- rev(pal)
  
  if (!is.null(n)) {
    if (n <= length(pal)) {
      pal <- pal[1:n]
    } else {
      pal <- colorRampPalette(pal)(n)
    }
  }
  
  return(pal)
}
```

Now we can create custom "theme_urban".

```{r}
# Main Urban Institute theme function
theme_urban <- function(base_size = 12,
                        base_family = "Lato",
                        base_line_size = 0.5,
                        base_rect_size = 0.5) {
  
  theme_minimal(base_size = base_size,
                base_family = base_family,
                base_line_size = base_line_size,
                base_rect_size = base_rect_size) +
    theme(
      # Plot elements
      plot.title = element_text(
        family = "Lato Bold",
        size = rel(2),
        face = "bold",
        hjust = 0,
        margin = margin(b = 10),
        color = urban_colors$black
      ),
      plot.subtitle = element_text(
        size = rel(1.5),
        hjust = 0,
        margin = margin(b = 15),
        color = urban_colors$space_gray
      ),
      plot.caption = element_text(
        size = rel(1),
        hjust = 0,
        margin = margin(t = 15),
        color = urban_colors$space_gray
      ),
      plot.title.position = "plot",
      plot.caption.position = "plot",
      plot.background = element_rect(fill = "white", color = NA),
      
      # Panel elements
      panel.grid.major = element_line(color = urban_colors$gray, size = 0.3),
      panel.grid.minor = element_blank(),
      panel.grid.major.x = element_blank(),
      panel.background = element_rect(fill = "white", color = NA),
      
      # Axis elements
      axis.title = element_text(
        family = "Lato Bold",
        size = rel(1.2),
        color = urban_colors$black,
        face = "bold"
      ),
      axis.title.x = element_text(margin = margin(t = 10)),
      axis.title.y = element_text(margin = margin(r = 10)),
      axis.text = element_text(
        size = rel(1),
        color = urban_colors$space_gray
      ),
      axis.ticks = element_blank(),
      axis.line = element_blank(),
      
      # Legend elements
      legend.position = "right",
      legend.justification = "left",
      legend.title = element_text(
        size = rel(1.1),
        face = "bold",
        color = urban_colors$black
      ),
      legend.text = element_text(
        size = rel(0.8),
        color = urban_colors$space_gray
      ),
      legend.key = element_blank(),
      legend.background = element_blank(),
      
      # Strip (facet) elements
      strip.text = element_text(
        family = "Lato Bold",
        size = rel(1),
        face = "bold",
        hjust = 0,
        color = urban_colors$black
      ),
      strip.background = element_blank(),
      
      # Margins
      plot.margin = margin(15, 15, 15, 15)
    )
}
```

Create color scales for discrete data.

```{r}
# Color scale functions
scale_color_urban <- function(palette = "categorical", reverse = FALSE, ...) {
  pal <- urban_palette(palette = palette, reverse = reverse)
  
  ggplot2::discrete_scale(
    "colour", 
    paste0("urban_", palette),
    palette = function(n) pal[1:n],
    ...
  )
}

scale_fill_urban <- function(palette = "categorical", reverse = FALSE, ...) {
  pal <- urban_palette(palette = palette, reverse = reverse)
  
  ggplot2::discrete_scale(
    "fill", 
    paste0("urban_", palette),
    palette = function(n) pal[1:n],
    ...
  )
}
```

Create color scales for continuous data.

```{r}
# Continuous color scales
scale_color_urban_c <- function(palette = "cyan_shade", reverse = FALSE, ...) {
  pal <- urban_palette(palette = palette, reverse = reverse)
  
  ggplot2::scale_color_gradientn(colors = pal, ...)
}

scale_fill_urban_c <- function(palette = "cyan_shade", reverse = FALSE, ...) {
  pal <- urban_palette(palette = palette, reverse = reverse)
  
  ggplot2::scale_fill_gradientn(colors = pal, ...)
}
```

Create a sample bar graph.

```{r}
# Example usage
sample_df <- data.frame(
  category = c("Category A", "Category B", "Category C", "Category D"),
  value = c(23, 45, 12, 34)
)

sample_p <- ggplot(sample_df, aes(x = reorder(category, value), y = value)) +
  geom_col(fill = urban_colors$cyan, width = 0.7) +
  coord_flip() +
  labs(
    title = "Example with Lato Font",
    subtitle = "Urban Institute styling with proper typography",
    caption = "Source: Example data",
    x = NULL,
    y = "Values"
  ) +
  theme_urban()

print(sample_p)

# Save with proper font rendering
ggsave("urban_plot.png", sample_p, width = 8, height = 6, dpi = 150)
```

We can also apply it to our Gapminder plot:

```{r}
# Example plot
p +
  theme_urban()

```

Note: the layout and fonts for the Gapminder plot have changed, but the colors remain the same. We need to explicitly call a UI color palette using the `scale_color_urban()` function defined above.

```{r}
p_urban <- ggplot(tempdf, aes(x= gdpPercap, y=lifeExp, color=continent, size=pop)) +
    geom_point(alpha=0.6) +
    scale_x_continuous(trans="log10") +
    scale_size_continuous(range = c(1, 15)) +
    scale_color_urban(palette = "categorical") +  # Add this line for colors
    labs(x="GDP per capita", y = "Life expectancy at birth (years)", 
         title = sprintf("Scatterplot: per capita GDP vs. life expectancy, %s", yr),
         caption = "(Based on data from Hans Rosling - gapminder.com)", 
         color = 'Continent',
         size = "Population") +
    theme_urban()  # This handles the styling/typography

ggsave("gapminder_UrbanInst-theme.png", p_urban, width = 5, height = 4)
p

```

For further instructions how to create custom themes visit [Maddie Pickens, "Learning to create custom themes in ggplot"](https://rpubs.com/mclaire19/ggplot2-custom-themes).

\*\*In the following notebook, you will use AI - LLMs specifically - to help you create your own custom theme.

# 

# 
